<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>

<muclient>
<plugin
   name="Aardwolf_FindTrigger"
   author="Sath"
   id="689d2c5e538c454796324a3a"
   language="Lua"
   purpose="'findtrigger <line>' finds triggers matching a given line of text."
   save_state="y"
   date_written="2026-02-15 19:30:00"
   requires="4.73"
   version="1.001"
   >
<description trim="y">
<![CDATA[
** This plugin finds triggers matching a given line of text.
]]>
</description>

</plugin>

<aliases>
    <alias
       match="findtrigger reload"
       enabled="y"
       script="reload_plugin"
       sequence="100"
    />
    <alias
       match="findtrigger update check"
       enabled="y"
       script="update_check_alias"
       sequence="100"
    />
    <alias
       match="findtrigger update install"
       enabled="y"
       script="update_install_alias"
       sequence="100"
    />
    <alias
        match="findtrigger *"
        enabled="y"
        script="findtrigger_alias"
        sequence="110"
    />
</aliases>

<script>
<![CDATA[

require("rex")
require("wait")
require("async")

function OnPluginInstall()
    ColourNote("white", "", plugin_prefix .. " Installed v" .. GetPluginInfo(GetPluginID(), 19) .. ". Use 'findtrigger <line>' to find triggers that will match the given line of text.")
end

local TRIGGER_MATCH_TEXT = 1
local TRIGGER_SCRIPT_NAME = 4
local TRIGGER_ENABLED = 8
local TRIGGER_OMIT_FROM_OUTPUT = 6
local TRIGGER_REGEXP = 9

local function GetAnyTriggerInfo(plugin_id, trigger_name, info_type)
    if plugin_id == "" then
        return GetTriggerInfo(trigger_name, info_type)
    else
        return GetPluginTriggerInfo(plugin_id, trigger_name, info_type)
    end
end

function findtrigger_alias(name, line, wc)
    local search_text = wc[1]
    ColourNote("white", "", "Searching for triggers matching: " .. search_text .. " ...")

    -- Prepare list of scopes (Global + Plugins)
    local scopes = { {id = "", name = "Global/Client"} }
    local plugin_list = GetPluginList()
    if plugin_list then
        for _, plugin_id in ipairs(plugin_list) do
            table.insert(scopes, {id = plugin_id, name = GetPluginInfo(plugin_id, 1)})
        end
    end
    
    local total_matches = 0

    for _, scope in ipairs(scopes) do
        local trigger_list
        if scope.id == "" then
            trigger_list = GetTriggerList()
        else
            trigger_list = GetPluginTriggerList(scope.id)
        end

        scope.matches = {}

        if trigger_list then
            for _, trigger_name in ipairs(trigger_list) do
                local match_str = GetAnyTriggerInfo(scope.id, trigger_name, TRIGGER_MATCH_TEXT)
                if match_str then
                    local is_regex = GetAnyTriggerInfo(scope.id, trigger_name, TRIGGER_REGEXP)
                    local re_str = match_str
                    
                    if not is_regex then
                        -- Convert wildcard to regex
                        -- Escape special characters: ^ $ ( ) % . [ ] + - ?
                        re_str = string.gsub(re_str, "[%^%$%(%)%%%.%[%]%+%-%?]", "%%%1")
                        -- Replace * with (.*?)
                        re_str = string.gsub(re_str, "%*", "(.*?)")
                        -- Anchor
                        re_str = "^" .. re_str .. "$"
                    end

                    local re = nil
                    local success, err = pcall(function() 
                        re = rex.new(re_str) 
                    end)

                    if success and re then
                        if re:match(search_text) then
                            table.insert(scope.matches, {
                                name = trigger_name,
                                match = match_str,
                                enabled = GetAnyTriggerInfo(scope.id, trigger_name, TRIGGER_ENABLED),
                                script = GetAnyTriggerInfo(scope.id, trigger_name, TRIGGER_SCRIPT_NAME),
                                squelch = GetAnyTriggerInfo(scope.id, trigger_name, TRIGGER_OMIT_FROM_OUTPUT)
                            })
                        end
                    end
                end
            end
        end
        total_matches = total_matches + #scope.matches
    end

    if total_matches == 0 then
        ColourNote("silver", "", "No matching triggers found.")
    else
        ColourNote("white", "", "Found " .. total_matches .. " matching trigger(s):")
        
        for _, scope in ipairs(scopes) do
            if #scope.matches > 0 then
                ColourNote("cyan", "", scope.name .. ":")
                
                -- Sort by enabled, then name
                table.sort(scope.matches, function(a, b)
                    if a.enabled ~= b.enabled then return a.enabled end
                    return a.name < b.name
                end)

                for _, match in ipairs(scope.matches) do
                    local color = "white" -- Default for disabled
                    local status = "[Disabled]"
                    if match.enabled then
                        color = "lime"
                        status = "[Enabled] "
                    else
                        color = "red"
                    end

                    local squelch = ""
                    if match.squelch then
                        squelch = " [Squelch]"
                    end

                    local script = ""
                    if match.script and match.script ~= "" then
                        script = " -> " .. match.script
                    end
                    
                    ColourTell(color, "", "  " .. status)
                    ColourTell("silver", "", match.name)
                    ColourTell("gray", "", " (" .. match.match .. ")")
                    ColourTell("yellow", "", script)
                    ColourTell("orange", "", squelch)
                    Note()
                end
            end
        end
    end
end

----------------------- Plugin Update Code -----------------------
-- URL would be updated when hosted
plugin_url = "https://sethbling.s3.us-west-2.amazonaws.com/Downloads/Aardwolf/plugins/aard_findtrigger.xml"
SetVariable("DownloadURL", plugin_url)
plugin_protocol = "HTTPS"
plugin_prefix = "[FindTrigger]"


function update_check_alias()
    update_plugin("check")
    ColourNote("white", "", plugin_prefix .. " Checking for updated version...")
end

function update_install_alias()
    update_plugin("install")
    ColourNote("white", "", plugin_prefix .. " Checking for and installing updated version...")
end

function reload_plugin()
    local scriptPrefix = GetAlphaOption("script_prefix")
    local retval

    -- If the user has not already specified the script prefix for this version of mush, pick a
    -- reasonable default value
    if (scriptPrefix == "") then
        scriptPrefix = "\\\\\\"
        SetAlphaOption("script_prefix", scriptPrefix)
    end

    -- Tell mush to reload the plugin in one second.  We can't do it directly here because a
    -- plugin can't unload itself.  Even if it could, how could it tell mush to load it again
    -- if it weren't installed? 
    retval = Execute(scriptPrefix.."DoAfterSpecial(0.1, \"ReloadPlugin('"..GetPluginID().."')\", sendto.script)")
end

function update_plugin(mode)
    update_mode = mode

    wait.make(get_plugin_file)
end

function get_plugin_file()
    local urlThread = async.request(plugin_url, plugin_protocol)

    if not urlThread then
        ColourNote("red", "", "Couldn't create async url request.")
        return
    end

    local timeout = 10
    local totTime = 0
    while (urlThread:alive() and totTime < timeout) do
        wait.time(0.1)
        totTime = totTime + 0.1
    end

    local remoteRet, pluginData, status, headers, fullStatus = urlThread:join()

    if not status then
        ColourNote("red", "", plugin_prefix .. " Couldn't download plugin file. No status code.")
        
        return
    end

    if (status ~= 200) then
        ColourNote("red", "", plugin_prefix .. " Plugin file request status code: " .. status .. ": " .. fullStatus)
        return
    end
    
    local currentVersion = GetPluginInfo(GetPluginID(), 19) or 0
    local currentVerStr  = string.format("%1.3f", currentVersion)
    local remoteVerStr   = string.match(pluginData, '%s%s+version="([0-9%.]+)"')
    local remoteVersion  = tonumber(remoteVerStr or "") or 0

    if remoteVersion == currentVersion then
        ColourNote("white", "", plugin_prefix .. " You are running the most recent version (v" .. currentVerStr .. ")")
    elseif (remoteVersion < currentVersion) then
        ColourNote("white", "", plugin_prefix .. " You have a newer version than is publicly available. (v" .. currentVerStr .. ")")
    elseif (update_mode == "check") then
        ColourNote("white", "", plugin_prefix .. " You are running v" .. currentVerStr .. ", but there's a newer version v" .. remoteVerStr)
    elseif (update_mode == "install") then
        ColourNote("white", "", plugin_prefix .. " Updating plugin from version " .. currentVerStr .. " to version " .. remoteVerStr) 

        local pluginFile = GetPluginInfo(GetPluginID(), 6)
        local file = io.open(pluginFile, "wb")

        if file then
            file:write(pluginData)
            file:close()
            reload_plugin()
        else
            ColourNote("red", "", plugin_prefix .. " Couldn't open file " .. pluginFile .. " for writing.")
        end
    else
        ColourNote("red", "", plugin_prefix .. " Invalid update mode: " .. update_mode)
    end
end
----------------------- End Plugin Update Code -----------------------

]]>
</script>

</muclient>
